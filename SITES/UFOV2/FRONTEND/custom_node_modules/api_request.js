exports.apirequest={ API_Query_Get, API_Query_Post };
var querystring = require('querystring');
const { exec } = require("child_process");
var mysql = require('mysql');
var db_connection = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "",
    database: "ufo"
  });
  db_connection.connect(function(err) {
    if (err) throw err;
    console.log("Connected!");
});
 //https://nodejs.dev/making-http-requests-with-nodejs
function API_Query_Post(req, res) {
  let body = '';
  req.on('error', (err) => {
      if(err) {
          response.writeHead(500, {'Content-Type': 'text/html'});
          response.write('An error occurred');
          response.end();
      }q
  });
  // read chunks
  req.on('data', chunk => {
      body += chunk.toString();
  });
  req.on('end', () => {
      body = querystring.parse(body);
      console.log(body.command);
    if(body.command.includes("addperson")){
      console.log("Command-> AddPerson");
      addperson(body,res);
    }
  });
}
function addperson(parameters,res)
{
  console.log(`LASTNAME= ${parameters.LASTNAME}  FIRSTNAME=${parameters.FIRSTNAME}  FONCTION= ${parameters.FONCTION} DOMAIN= ${parameters.DOMAIN}  COUNTRY=${parameters.COUNTRY}  IMPLICATION= ${parameters.IMPLICATION}  POSITION ${parameters.POSITION} `);
  var sql_query = `INSERT INTO person(ID_person, Name,Firstname, Fonction, Domain, Country, Implication, Position) VALUES (NULL, "${parameters.LASTNAME}" ,"${parameters.FIRSTNAME}","${parameters.FONCTION}","${parameters.DOMAIN}" ,"${parameters.COUNTRY}" ,"${parameters.IMPLICATION}","${parameters.POSITION}")`;
  console.log(sql_query);
  db_connection.query(sql_query, function (err, result) {
    if (err) { console.log("Catch:"+err);
    }
    else
    {
      console.log(result);
      //var json=result;
      res.writeHead(200, { 'Content-Type': 'text/javascript' });
      res.write("From server:Entry saved!");
      // res.write(JSON.stringify(result));
      res.end();
    }
});
}
function API_Query_Get(req, res) {
  const myURL = new URL(req.url.toString(), 'http://localhost:8081/');
  console.log(myURL.searchParams.get('command'));
  var cmd=myURL.searchParams.get('command');
      var sql_query = "SELECT * FROM `person` WHERE 1";
      db_connection.query(sql_query, function (err, result) {
        if (err) {throw err;}
        else
        {
          console.log(result);
          //var json=result;
          res.writeHead(200, { 'Content-Type': 'text/html' });
          res.write("From server:Entry saved!");
          res.end();
        }
   });
}
